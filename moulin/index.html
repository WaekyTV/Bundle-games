<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu du Moulin</title>
    <style>
        /* Thème sombre cohérent */
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
        }
        h1 {
            color: #00ff99; /* Vert néon */
        }
        
        #board-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 20px;
            border: 1px solid #6441a5;
        }

        /* Dessin du plateau (lignes statiques) */
        .line {
            position: absolute;
            background-color: #e0e0e0;
        }
        /* Lignes Horizontales */
        .line.h { height: 2px; }
        .line.h1 { top: 10px; left: 10px; width: 380px; }
        .line.h2 { top: 60px; left: 60px; width: 280px; }
        .line.h3 { top: 110px; left: 110px; width: 180px; }
        .line.h4 { top: 200px; left: 10px; width: 90px; }
        .line.h5 { top: 200px; right: 10px; width: 90px; }
        .line.h6 { bottom: 110px; left: 110px; width: 180px; }
        .line.h7 { bottom: 60px; left: 60px; width: 280px; }
        .line.h8 { bottom: 10px; left: 10px; width: 380px; }
        
        /* Lignes Verticales */
        .line.v { width: 2px; }
        .line.v1 { top: 10px; left: 10px; height: 90px; }
        .line.v2 { top: 60px; left: 60px; height: 90px; }
        .line.v3 { top: 110px; left: 110px; height: 90px; }
        .line.v4 { top: 10px; left: 200px; height: 90px; }
        .line.v5 { top: 10px; right: 10px; height: 90px; }
        .line.v6 { top: 60px; right: 60px; height: 90px; }
        .line.v7 { top: 110px; right: 110px; height: 90px; }
        
        .line.v8 { top: 200px; left: 10px; height: 90px; }
        .line.v9 { top: 200px; left: 60px; height: 90px; }
        .line.v10 { top: 200px; left: 110px; height: 90px; }
        .line.v11 { top: 200px; right: 10px; height: 90px; }
        .line.v12 { top: 200px; right: 60px; height: 90px; }
        .line.v13 { top: 200px; right: 110px; height: 90px; }


        /* Les intersections (points cliquables) */
        .intersection {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #1a1a2e; /* Couleur de fond */
            border: 2px solid #e0e0e0;
            cursor: pointer;
            z-index: 100;
        }
        .intersection:hover:not(.occupied):not(.removable) {
            background-color: #3e3e5e;
            border-color: #00ff99; /* Indique un emplacement possible */
        }

        /* Pièces sur le plateau */
        .piece {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .player1 { background-color: #027afa; } /* Bleu (Joueur 1/Blanc) */
        .player2 { background-color: #FF4136; } /* Rouge (Joueur 2/Noir) */
        
        /* Pièce sélectionnée (pour le mouvement) */
        .selected .piece {
            border: 2px solid #00ff99; 
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* Pièce qui peut être retirée */
        .removable {
            border: 2px solid #FFDC00; /* Jaune */
            cursor: crosshair;
        }
        .removable .piece {
            box-shadow: 0 0 10px #FFDC00;
        }

        /* Compteurs de pièces */
        #counters {
            display: flex;
            justify-content: space-around;
            width: 400px;
            margin-top: 10px;
            font-size: 1.1em;
        }

        /* Indicateur de tour et statut */
        #status {
            font-size: 1.2em;
            margin: 15px 0;
            min-height: 25px;
            color: #FFDC00; /* Jaune */
            text-align: center;
        }
        
        /* Boutons et lien */
        button {
            background-color: #00ff99;
            border: none;
            color: #1a1a2e;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        a {
            display: inline-block;
            margin-top: 15px;
            color: #00ff99;
            text-decoration: none;
            font-size: 1.1em;
        }
    </style>
</head>
<body>

    <h1>Jeu du Moulin</h1>
    
    <div id="status"></div>
    
    <div id="board-container">
        <div class="line h h1"></div><div class="line v v1"></div>
        <div class="line h h2"></div><div class="line v v2"></div>
        <div class="line h h3"></div><div class="line v v3"></div>
        <div class="line h h4"></div><div class="line h h5"></div>
        <div class="line h h6"></div><div class="line v v7"></div>
        <div class="line h h7"></div><div class="line v v6"></div>
        <div class="line h h8"></div><div class="line v v5"></div>

        <div class="line v v4" style="left: 200px;"></div>
        <div class="line v v5" style="left: 390px;"></div>

        <div class="line v v8" style="top: 200px; left: 10px; height: 180px;"></div>
        <div class="line v v9" style="top: 200px; left: 60px; height: 90px;"></div>
        <div class="line v v10" style="top: 200px; left: 110px; height: 90px;"></div>
        <div class="line v v11" style="top: 290px; left: 200px; height: 90px;"></div>
        <div class="line v v12" style="top: 200px; right: 60px; height: 90px;"></div>
        <div class="line v v13" style="top: 200px; right: 10px; height: 180px;"></div>

        </div>
    
    <div id="counters">
        <span id="p1-counter">Bleu : 9 pièces restantes</span>
        <span id="p2-counter">Rouge : 9 pièces restantes</span>
    </div>

    <div>
        <button id="restartButton">Nouvelle Partie</button>
        <a href="../index.html">Retour au menu</a>
    </div>

    <script>
        // Coordonnées absolues des 24 intersections (x, y)
        const POSITIONS = [
            // Côtés (Ex: 0: 10, 10)
            [10, 10], [200, 10], [390, 10], // Ligne 1
            [60, 60], [200, 60], [340, 60], // Ligne 2
            [110, 110], [200, 110], [290, 110], // Ligne 3
            [10, 200], [60, 200], [110, 200], // Ligne 4 Gauche
            [290, 200], [340, 200], [390, 200], // Ligne 4 Droite
            [110, 290], [200, 290], [290, 290], // Ligne 5
            [60, 340], [200, 340], [340, 340], // Ligne 6
            [10, 390], [200, 390], [390, 390] // Ligne 7
        ];

        // Connexions entre les intersections (index du POSITIONS)
        const CONNECTIONS = [
            [0, 1], [1, 2], [3, 4], [4, 5], [6, 7], [7, 8],
            [9, 10], [10, 11], [12, 13], [13, 14],
            [15, 16], [16, 17], [18, 19], [19, 20], [21, 22], [22, 23],
            // Verticales et Centre
            [0, 9], [9, 21], [3, 10], [10, 18], [6, 11], [11, 15],
            [1, 4], [4, 7], [7, 16], [16, 19], [19, 22],
            [2, 14], [14, 23], [5, 13], [13, 20], [8, 12], [12, 17]
        ];

        // Les lignes qui forment un moulin (index de 3 positions alignées)
        const MILL_LINES = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], [9, 10, 11], [12, 13, 14],
            [15, 16, 17], [18, 19, 20], [21, 22, 23], // Horizontales
            [0, 9, 21], [3, 10, 18], [6, 11, 15], [1, 4, 7], [16, 19, 22],
            [8, 12, 17], [5, 13, 20], [2, 14, 23] // Verticales et Centre
        ];


        const boardContainer = document.getElementById('board-container');
        const statusElement = document.getElementById('status');
        const p1Counter = document.getElementById('p1-counter');
        const p2Counter = document.getElementById('p2-counter');

        let boardState = new Array(24).fill(0); // 0: vide, 1: P1, 2: P2
        let currentPlayer = 1; // 1: Bleu, 2: Rouge
        let piecesToPlace = { 1: 9, 2: 9 };
        let piecesOnBoard = { 1: 0, 2: 0 };
        let phase = 'PLACEMENT'; // 'PLACEMENT', 'MOUVEMENT', 'PRISE'
        let selectedPosition = -1; // Index de la pièce sélectionnée pour le mouvement
        let gameActive = true;
        let isFlying = { 1: false, 2: false }; // Peut voler (quand il reste 3 pièces)

        // --- Fonctions d'Initialisation et de Rendu ---

        function initializeGame() {
            boardState = new Array(24).fill(0);
            piecesToPlace = { 1: 9, 2: 9 };
            piecesOnBoard = { 1: 0, 2: 0 };
            currentPlayer = 1;
            phase = 'PLACEMENT';
            selectedPosition = -1;
            gameActive = true;
            isFlying = { 1: false, 2: false };
            
            // Dessine les intersections et les pièces
            renderBoard();
            updateStatus();
            updateCounters();
        }

        function renderBoard() {
            // Retire seulement les intersections existantes, pas les lignes statiques
            document.querySelectorAll('.intersection').forEach(n => n.remove());

            POSITIONS.forEach((pos, index) => {
                const node = document.createElement('div');
                node.classList.add('intersection');
                node.style.left = `${pos[0]}px`;
                node.style.top = `${pos[1]}px`;
                node.dataset.index = index;

                const pieceType = boardState[index];
                if (pieceType !== 0) {
                    node.classList.add('occupied');
                    const piece = document.createElement('div');
                    piece.classList.add('piece', `player${pieceType}`);
                    node.appendChild(piece);
                    
                    // Ajoute l'écouteur de clic pour le mouvement (pas en phase de placement)
                    if (phase !== 'PLACEMENT' && pieceType === currentPlayer) {
                        node.addEventListener('click', handlePieceClick);
                    }
                    
                    // Style de sélection pour le mouvement
                    if (selectedPosition === index) {
                         node.classList.add('selected');
                    }
                } else {
                    node.classList.remove('occupied');
                    
                    // Ajoute l'écouteur de clic pour le placement ou la destination
                    node.addEventListener('click', handleBoardClick);
                }
                
                // Ajoute l'écouteur de clic pour la phase de PRISE
                if (phase === 'PRISE' && pieceType !== 0 && pieceType !== currentPlayer && !isMill(index, pieceType)) {
                     node.classList.add('removable');
                     node.addEventListener('click', handleRemoveClick);
                }


                boardContainer.appendChild(node);
            });
        }
        
        // Met à jour les textes d'état et les compteurs
        function updateStatus() {
            let playerColor = currentPlayer === 1 ? 'Bleu' : 'Rouge';
            let phaseText = '';

            switch (phase) {
                case 'PLACEMENT':
                    phaseText = `Phase 1 (Placement). ${playerColor}, placez une pièce. (${piecesToPlace[currentPlayer]} restantes)`;
                    break;
                case 'MOUVEMENT':
                    let action = isFlying[currentPlayer] ? 'vôlez' : 'déplacez-vous';
                    phaseText = `Phase 2 (Mouvement). ${playerColor}, sélectionnez une pièce à ${action}.`;
                    break;
                case 'PRISE':
                    phaseText = `Phase 3 (Prise). ${playerColor}, retirez une pièce adverse.`;
                    break;
                case 'FIN':
                    phaseText = `🏆 FIN : Le joueur ${playerColor} a gagné !`;
                    break;
            }
            statusElement.textContent = phaseText;
            p1Counter.textContent = `Bleu : ${piecesOnBoard[1]} en jeu (${piecesToPlace[1]} en main)`;
            p2Counter.textContent = `Rouge : ${piecesOnBoard[2]} en jeu (${piecesToPlace[2]} en main)`;
        }


        // --- Logique de Clic ---

        // Clic sur une intersection vide (pour placer ou se déplacer)
        function handleBoardClick(e) {
            if (!gameActive) return;
            const targetIndex = parseInt(e.currentTarget.dataset.index);

            // Phase de PLACEMENT
            if (phase === 'PLACEMENT') {
                if (boardState[targetIndex] === 0 && piecesToPlace[currentPlayer] > 0) {
                    boardState[targetIndex] = currentPlayer;
                    piecesToPlace[currentPlayer]--;
                    piecesOnBoard[currentPlayer]++;
                    
                    if (isMill(targetIndex, currentPlayer)) {
                        phase = 'PRISE';
                    } else {
                        switchTurn();
                    }
                    renderBoard();
                }
            } 
            // Phase de MOUVEMENT (destination)
            else if (phase === 'MOUVEMENT' && selectedPosition !== -1) {
                if (boardState[targetIndex] === 0) {
                    const isValidMove = isFlying[currentPlayer] || isNeighbor(selectedPosition, targetIndex);
                    
                    if (isValidMove) {
                        boardState[targetIndex] = currentPlayer;
                        boardState[selectedPosition] = 0;
                        selectedPosition = -1;

                        if (isMill(targetIndex, currentPlayer)) {
                            phase = 'PRISE';
                        } else {
                            switchTurn();
                            checkGameEnd();
                        }
                        renderBoard();
                    }
                }
            }
        }

        // Clic sur une pièce alliée (pour la sélectionner et la bouger)
        function handlePieceClick(e) {
            if (!gameActive || phase !== 'MOUVEMENT') return;
            const targetIndex = parseInt(e.currentTarget.dataset.index);

            if (boardState[targetIndex] === currentPlayer) {
                // Si on reclique sur la pièce sélectionnée, on désélectionne
                if (selectedPosition === targetIndex) {
                    selectedPosition = -1;
                } else {
                    selectedPosition = targetIndex;
                }
                renderBoard();
            }
        }

        // Clic sur une pièce adverse (pour la retirer)
        function handleRemoveClick(e) {
             if (!gameActive || phase !== 'PRISE') return;
             const targetIndex = parseInt(e.currentTarget.dataset.index);
             const opponent = currentPlayer === 1 ? 2 : 1;

             // S'assurer que c'est une pièce adverse
             if (boardState[targetIndex] === opponent) {
                  // Vérifie si la pièce n'est PAS dans un moulin (sauf si toutes les pièces adverses sont dans des moulins)
                  const isOpponentInMill = isMill(targetIndex, opponent);
                  
                  // On peut retirer une pièce dans un moulin UNIQUEMENT si toutes les pièces adverses sont dans des moulins
                  const allOpponentInMills = piecesOnBoard[opponent] <= 3 || areAllPiecesInMills(opponent); // Simplification de la règle
                  
                  if (!isOpponentInMill || allOpponentInMills) {
                     boardState[targetIndex] = 0; // Pièce retirée
                     piecesOnBoard[opponent]--; // Compteur mis à jour

                     switchTurn(); // Fin de la phase de prise, passage au joueur suivant
                     checkGameEnd(); // Vérifie la victoire
                  } else {
                      statusElement.textContent = `Cette pièce fait partie d'un moulin. Trouvez une pièce isolée !`;
                      return; // Ne change pas le tour
                  }
             }
        }
        
        // Vérifie si toutes les pièces d'un joueur sont dans des moulins
        function areAllPiecesInMills(player) {
            for(let i = 0; i < 24; i++) {
                if (boardState[i] === player && !isMill(i, player)) {
                    return false;
                }
            }
            return true;
        }

        // --- Fonctions de Logique de Jeu ---

        // Vérifie si une position fait partie d'un moulin (3 pièces alignées)
        function isMill(posIndex, player) {
            return MILL_LINES.some(line => {
                // La position en cours fait partie de cette ligne
                if (line.includes(posIndex)) {
                    // Vérifie si les 3 positions sont occupées par le même joueur
                    return line.every(index => boardState[index] === player);
                }
                return false;
            });
        }
        
        // Vérifie si deux positions sont voisines (connectées)
        function isNeighbor(index1, index2) {
            for (const connection of CONNECTIONS) {
                // Vérifie si la connexion [index1, index2] ou [index2, index1] existe
                if ((connection[0] === index1 && connection[1] === index2) || 
                    (connection[0] === index2 && connection[1] === index1)) {
                    return true;
                }
            }
            return false;
        }
        
        // Change de tour et passe à la phase de mouvement si toutes les pièces sont placées
        function switchTurn() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            
            // Passe à la phase de mouvement une fois que toutes les pièces sont sur le plateau
            if (piecesToPlace[1] === 0 && piecesToPlace[2] === 0) {
                phase = 'MOUVEMENT';
                
                // Règle du "vol" (Flying Rule): s'il reste seulement 3 pièces
                isFlying[currentPlayer] = (piecesOnBoard[currentPlayer] <= 3);
            }
            
            renderBoard();
            updateStatus();
        }

        // Vérifie la condition de victoire
        function checkGameEnd() {
            // Victoire si l'adversaire a moins de 3 pièces OU ne peut plus bouger
            const opponent = currentPlayer === 1 ? 2 : 1;
            
            if (piecesOnBoard[opponent] < 3 && phase !== 'PLACEMENT') {
                endGame(currentPlayer);
            }
            // Simplification: ne vérifions pas l'absence de coup légal ici (trop complexe en JS vanilla)
        }
        
        function endGame(winner) {
            gameActive = false;
            phase = 'FIN';
            let winnerColor = winner === 1 ? 'Bleu' : 'Rouge';
            statusElement.textContent = `🏆 FIN : Le joueur ${winnerColor} a gagné en laissant son adversaire à moins de 3 pièces !`;
            console.log(`Le joueur ${winnerColor} a gagné ! On enverra l'XP plus tard.`);
        }

        // --- Événements ---
        restartButton.addEventListener('click', initializeGame);
        
        // Lancement du jeu au chargement de la page
        initializeGame();
    </script>
</body>
</html>
